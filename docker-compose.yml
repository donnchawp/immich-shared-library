# Run with: docker compose up -d
# Requires the Immich stack to be running (connects to its network)

services:
  immich-shared-library:
    build: .
    container_name: immich_shared_library
    # Set PUID/PGID in .env to match file ownership (defaults to root, matching Immich)
    user: "${PUID:-0}:${PGID:-0}"
    env_file: .env
    environment:
      DB_HOSTNAME: immich_postgres
      DB_PORT: 5432
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DATABASE_NAME: ${DB_DATABASE_NAME:-immich}

      IMMICH_API_URL: http://immich_server:2283
      IMMICH_API_KEY: ${IMMICH_API_KEY}

      SYNC_INTERVAL_SECONDS: ${SYNC_INTERVAL_SECONDS:-60}

      SOURCE_USER_ID: ${SOURCE_USER_ID}
      TARGET_USER_ID: ${TARGET_USER_ID}
      TARGET_LIBRARY_ID: ${TARGET_LIBRARY_ID}
      SHARED_PATH_PREFIX: ${SHARED_PATH_PREFIX}
      TARGET_PATH_PREFIX: ${TARGET_PATH_PREFIX}

      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      # Must match Immich's upload and external library mounts (both host path and container path)
      - ${UPLOAD_LOCATION}:${UPLOAD_LOCATION_MOUNT:-/usr/src/app/upload}
      - ${EXTERNAL_LIBRARY_DIR}:${EXTERNAL_LIBRARY_MOUNT:-/external_library}
    networks:
      - immich
    restart: always
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080')"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  immich:
    external: true
    name: immich_default
